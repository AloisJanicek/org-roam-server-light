#+TITLE: Readme

* org-roam-server-light

This projects attempts to move [[https://github.com/org-roam/org-roam-server][org-roam-server]] functionality from emacs into external python server process due to subjective poor elisp / emacs performance when computing graph data for larger amount of org-roam files and serving them to web browser.

** Warning
My first time touching python more deeply then Hello World!

** Prerequisites
File-preview functionality requires [[https://pandoc.org/][pandoc]] being available in your PATH

** Installation
#+BEGIN_EXAMPLE
git clone https://github.com/AloisJanicek/org-roam-server-light.git
#+END_EXAMPLE

Add following elisp code into your emacs config and ensure that =org-roam-server-light-dir= points to valid directory

** Elisp code
#+BEGIN_SRC emacs-lisp
(require 'f)

(defvar org-roam-server-light-dir "~/org-roam-server-light"
  "Directory contenting org-roam-server-light repository.")

(defun org-roam-server-light-update-last-buffer ()
  "Update `org-roam-server-light-last-roam-buffer'."
  (let ((buf (or (buffer-base-buffer (current-buffer)) (current-buffer))))
    (when (org-roam--org-roam-file-p
           (buffer-file-name buf))
      (setq org-roam-server-light-last-roam-buffer (car (last
                                                            (split-string
                                                             (org-roam--path-to-slug
                                                              (buffer-name buf))
                                                             "/"))))
      (f-write-text org-roam-server-light-last-roam-buffer
                    'utf-8
                    (format "/tmp/org-roam-server-light/%s" (symbol-name 'org-roam-server-light-last-roam-buffer))))))

(defun org-roam-server-light-find-file-hook-function ()
  "If the current visited file is an `org-roam` file, update the current buffer."
  (when (org-roam--org-roam-file-p)
    (add-hook 'post-command-hook #'org-roam-server-light-update-last-buffer nil t)
    (org-roam-server-light-update-last-buffer)))

(define-minor-mode org-roam-server-light-mode
  "Start the http server and serve org-roam files."
  :lighter ""
  :global t
  :init-value nil
  (let* ((title "org-roam-server-light")
         (tmp-dir (concat "/tmp/" title)))
    (if (not (ignore-errors org-roam-server-light-mode))
        (progn
          (when (get-process title)
            (delete-process title))
          (remove-hook 'find-file-hook #'org-roam-server-light-find-file-hook-function nil)
          (dolist (buf (org-roam--get-roam-buffers))
            (with-current-buffer buf
              (remove-hook 'post-command-hook #'org-roam-server-light-update-last-buffer t))))
      (progn
        (let ((default-directory org-roam-server-light-dir))
          (start-process-shell-command "org-roam-server-light" "org-roam-server-light-output-buffer" "python main.py"))
        (add-hook 'find-file-hook #'org-roam-server-light-find-file-hook-function nil nil)
        (unless (file-exists-p tmp-dir)
          (make-directory tmp-dir))
        (f-write-text org-roam-directory
                      'utf-8
                      (expand-file-name (symbol-name 'org-roam-directory) tmp-dir))))))

#+END_SRC

** Usage
Running =org-roam-server-light-mode= will start org-roam-server-light server on http://localhost:8080

** Roadmap and functionality overview
*** COMPLETED +Serve all kinds of static assets+
*** COMPLETED +Keep track of current buffer+
*** COMPLETED +Start and stop external python server process when you enable or disable org-roam-server-light-mode in emacs+
*** COMPLETED +Actually construct required JSON for vis-network in Python+
*** COMPLETED +Handle file previews+
*** COMPLETED +Fix href stuff for links in file preview+
*** COMPLETED +Handle /org-roam-buffer+
*** TODO Handle citelinks in roam-buffer pane
*** TODO Improve appearance of roam-buffer and file-preview panes


** Credits
Client side code, assets and some elisp copied as they are from [[https://github.com/org-roam/org-roam-server][org-roam-server]]
python code copied and expanded from [[https://github.com/aklatzke/python-webserver-part-2][aklatzke/python-webserver-part-2]]
